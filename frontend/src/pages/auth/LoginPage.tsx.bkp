import React, { useEffect, useMemo, useState } from "react";
import { useNavigate, Link, useLocation } from "react-router-dom";
import { AnimatePresence, motion } from "framer-motion";
import {
  Eye,
  EyeOff,
  XCircle,
  Mail,
  Lock,
  ArrowRight,
  ArrowLeft,
  Loader2,
  LogIn,
  Rocket,
  User,
  CheckCircle,
} from "lucide-react";

import { Button } from "../../components/ui/Button";
import { Input } from "../../components/ui/Input";
import { useAuthStore } from "../../store/authStore";
import { authService } from "../../services/authService";
import logo from "../../assets/logo.png";
import { toastError } from "@/lib/toast";

// ‚úÖ Hook reutiliz√°vel (Login + Register)
import { useEmailCheck } from "../../hooks/useEmailCheck";

//type Scene = "intro" | "choice" | "login" | "createAccount";
type Scene = "choice" | "login" | "createAccount";

type LoginStep = "email" | "password";
type CreateAccountStep = "name" | "email" | "password";

const ease = [0.16, 1, 0.3, 1];

const pageSwap = {
  initial: { opacity: 0, scale: 0.985, filter: "blur(6px)" },
  animate: { opacity: 1, scale: 1, filter: "blur(0px)", transition: { duration: 0.55, ease } },
  exit: { opacity: 0, scale: 0.99, filter: "blur(6px)", transition: { duration: 0.28, ease } },
};

const fadeSlide = {
  initial: { opacity: 0, y: 16, filter: "blur(6px)" },
  animate: { opacity: 1, y: 0, filter: "blur(0px)", transition: { duration: 0.55, ease } },
  exit: { opacity: 0, y: -10, filter: "blur(6px)", transition: { duration: 0.28, ease } },
};

function isValidEmail(email: string) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.trim());
}

export const LoginPage: React.FC = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const { setAuth, isAuthenticated } = useAuthStore();

  //const [scene, setScene] = useState<Scene>("intro");
  //const [introReady, setIntroReady] = useState(false);
  const [scene, setScene] = useState<Scene>("login");

  const [loginStep, setLoginStep] = useState<LoginStep>("email");
  const [showPassword, setShowPassword] = useState(false);

  const [isLoading, setIsLoading] = useState(false);
  const [loginError, setLoginError] = useState<string | null>(null);

  const [formData, setFormData] = useState({
    email: "",
    password: "",
    rememberMe: false,
  });

  // ----------------------- CREATE ACCOUNT STATE -----------------------
  const [createStep, setCreateStep] = useState<CreateAccountStep>("name");

  const [createData, setCreateData] = useState({
    name: "",
    email: "",
    password: "",
    confirmPassword: "",
    termsAccepted: false,
  });

  const [createError, setCreateError] = useState<string | null>(null);
  const [showCreatePassword, setShowCreatePassword] = useState(false);
  const [showCreateConfirmPassword, setShowCreateConfirmPassword] = useState(false);

  // Redirect se j√° autenticado
  useEffect(() => {
    if (isAuthenticated) navigate("/dashboard");
  }, [isAuthenticated, navigate]);

  // ‚úÖ Permite abrir uma cena espec√≠fica quando vier do Register (Voltar 1 / J√° tenho conta)
  useEffect(() => {
    const desired = (location.state as any)?.scene as Scene | undefined;
    if (!desired) return;

    //if (desired === "intro" || desired === "choice" || desired === "login" || desired === "createAccount") {
    if (desired === "choice" || desired === "login" || desired === "createAccount") {
      setScene(desired);
      setLoginStep("email");
      setLoginError(null);
      setIsLoading(false);
      emailCheck.reset();
      setFormData((p) => ({ ...p, password: "" }));

      if (desired === "createAccount") {
        setCreateStep("name");
        setCreateError(null);
        createEmailCheck.reset();
        setCreateData({
          name: "",
          email: "",
          password: "",
          confirmPassword: "",
          termsAccepted: false,
        });
        setShowCreatePassword(false);
        setShowCreateConfirmPassword(false);
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [location.state]);

  // Intro: libera bot√£o "Estou Pronto!" ap√≥s um tempo
  /*
  useEffect(() => {
    if (scene !== "intro") return;
    setIntroReady(false);
    const t = window.setTimeout(() => setIntroReady(true), 4200);
    return () => window.clearTimeout(t);
  }, [scene]);
  */

  const emailValid = useMemo(() => isValidEmail(formData.email), [formData.email]);

  /**
   * ‚úÖ FIX #1:
   * Antes: enabled s√≥ no step "email".
   * Problema: ao ir para "password", o hook podia ‚Äúdesativar‚Äù e seu status voltava p/ idle,
   * fazendo `emailExists` virar false no submit e te jogando de volta pro step de e-mail.
   *
   * Agora: enabled enquanto estiver na cena de login (independente do step),
   * e o reset continua acontecendo apenas quando o usu√°rio muda o e-mail.
   */
  const emailCheck = useEmailCheck({
    email: formData.email,
    enabled: scene === "login",
    debounceMs: 500,
    isValidEmail,
    checkEmailAvailability: (email) => authService.checkEmailAvailability(email),

    invalidEmailMessage: "Digite um e-mail v√°lido para localizar sua conta.",
    checkingMessage: "Procurando sua conta...",
    errorMessage: "N√£o foi poss√≠vel verificar agora. Tente novamente.",
    dedupeNotify: true,
  });

  // Mapeamento sem√¢ntico pro Login:
  // - exists => conta encontrada
  // - available => N√ÉO encontrado (porque ‚Äúdispon√≠vel‚Äù = n√£o existe no sistema)
  const emailExists = emailCheck.status === "exists";
  const emailNotFound = emailCheck.status === "available";
  const emailChecking = emailCheck.status === "checking";
  const emailErrored = emailCheck.status === "error";

  const canContinueEmail = emailValid && emailExists;

  const canSubmit = useMemo(
    () => emailValid && formData.password.length >= 6,
    [emailValid, formData.password]
  );

  const handleChange = (field: string, value: string | boolean) => {
    setFormData((prev) => ({ ...prev, [field]: value }));

    if (loginError) setLoginError(null);

    if (field === "email") {
      emailCheck.reset();
      setFormData((prev) => ({ ...prev, password: "" }));
      setLoginStep("email");
    }
  };

  const goLogin = () => {
    setScene("login");
    setLoginStep("email");
    setLoginError(null);
    setIsLoading(false);
    emailCheck.reset();
  };

  const handleSubmit = async (e?: React.FormEvent) => {
    if (e) e.preventDefault();
    if (isLoading) return;

    setLoginError(null);

    if (!emailValid) {
      setLoginStep("email");
      setLoginError("Digite um e-mail v√°lido.");
      return;
    }

    if (!emailExists) {
      setLoginStep("email");
      setLoginError("Email n√£o encontrado.");
      return;
    }

    if (formData.password.length < 6) {
      setLoginStep("password");
      setLoginError("Senha muito curta.");
      return;
    }

    setIsLoading(true);

    try {
      const response = await authService.login({
        email: formData.email,
        password: formData.password,
      });

      setAuth(response.user, response.defaultTenant, response.accessToken, response.refreshToken);
      navigate("/dashboard");
    } catch (err: any) {
      const message =
        err?.response?.data?.message ||
        "N√£o foi poss√≠vel entrar. Verifique seus dados e tente novamente.";

      setLoginError(message);

      toastError({
        id: "login-error",
        title: "Falha no login",
        description: message,
      });
    } finally {
      setIsLoading(false);
    }
  };

  const emailInputVariant = useMemo(() => {
    if (!formData.email.trim()) return "default";
    if (!emailValid) return "default";
    if (emailExists) return "success";
    if (emailNotFound || emailErrored) return "error";
    return "default";
  }, [formData.email, emailValid, emailExists, emailNotFound, emailErrored]);

  const emailHint = useMemo(() => {
    if (!formData.email.trim()) return "Digite seu e-mail para localizar sua conta.";
    if (!emailValid) return emailCheck.message || "Digite um e-mail v√°lido para localizar sua conta.";
    if (emailChecking) return "Procurando sua conta...";
    if (emailExists) return "Conta encontrada. Continue para sua senha.";
    if (emailNotFound) return "Email n√£o encontrado. Voc√™ pode criar uma conta agora.";
    if (emailErrored) return "N√£o foi poss√≠vel verificar agora. Voc√™ pode tentar novamente.";
    return "";
  }, [formData.email, emailValid, emailCheck.message, emailChecking, emailExists, emailNotFound, emailErrored]);

  const emailRightIcon = useMemo(() => {
    if (emailChecking) return <Loader2 className="w-5 h-5 animate-spin text-neutral-400" />;
    if (emailNotFound) return <XCircle className="w-5 h-5 text-danger-500" />;
    return null;
  }, [emailChecking, emailNotFound]);

  // ----------------------- CREATE ACCOUNT LOGIC -----------------------
  const createEmailValid = useMemo(() => isValidEmail(createData.email), [createData.email]);

  /**
   * ‚úÖ FIX #2:
   * Antes: enabled s√≥ no step "email".
   * Problema: ao ir para "password", o status podia ‚Äúzerar‚Äù, fazendo `createEmailAvailable`
   * ficar false e o bot√£o "Criar Conta" nunca habilitar.
   *
   * Agora: enabled enquanto estiver na cena createAccount (independente do step).
   */
  const createEmailCheck = useEmailCheck({
    email: createData.email,
    enabled: scene === "createAccount",
    debounceMs: 500,
    isValidEmail,
    checkEmailAvailability: (email) => authService.checkEmailAvailability(email),

    invalidEmailMessage: "Digite um e-mail v√°lido para continuar.",
    checkingMessage: "Verificando e-mail...",
    errorMessage: "N√£o foi poss√≠vel verificar agora. Tente novamente.",
    dedupeNotify: true,
  });

  // Para cadastro:
  // - available => pode criar
  // - exists => j√° cadastrado (bloqueia)
  const createEmailAvailable = createEmailCheck.status === "available";
  const createEmailExists = createEmailCheck.status === "exists";
  const createEmailChecking = createEmailCheck.status === "checking";
  const createEmailErrored = createEmailCheck.status === "error";

  const createEmailInputVariant = useMemo(() => {
    if (!createData.email.trim()) return "default";
    if (!createEmailValid) return "default";
    if (createEmailAvailable) return "success";
    if (createEmailExists || createEmailErrored) return "error";
    return "default";
  }, [createData.email, createEmailValid, createEmailAvailable, createEmailExists, createEmailErrored]);

  const createEmailRightIcon = useMemo(() => {
    if (createEmailChecking) return <Loader2 className="w-5 h-5 animate-spin text-neutral-400" />;
    if (createEmailExists) return <XCircle className="w-5 h-5 text-danger-500" />;
    if (createEmailAvailable && createEmailValid)
      return <CheckCircle className="w-5 h-5 text-success-500" />;
    return null;
  }, [createEmailChecking, createEmailExists, createEmailAvailable, createEmailValid]);

  const createEmailHint = useMemo(() => {
    if (!createData.email.trim()) return "Digite seu e-mail para criar sua conta.";
    if (!createEmailValid) return createEmailCheck.message || "Digite um e-mail v√°lido.";
    if (createEmailChecking) return "Verificando e-mail...";
    if (createEmailAvailable) return "E-mail dispon√≠vel. Continue.";
    if (createEmailExists) return "Esse e-mail j√° est√° cadastrado. Fa√ßa login.";
    if (createEmailErrored) return "N√£o foi poss√≠vel verificar agora. Voc√™ pode tentar novamente.";
    return "";
  }, [
    createData.email,
    createEmailValid,
    createEmailCheck.message,
    createEmailChecking,
    createEmailAvailable,
    createEmailExists,
    createEmailErrored,
  ]);

  const passwordRequirements = useMemo(
    () => [
      { label: "M√≠nimo 8 caracteres", met: createData.password.length >= 8 },
      { label: "Uma letra mai√∫scula", met: /[A-Z]/.test(createData.password) },
      { label: "Uma letra min√∫scula", met: /[a-z]/.test(createData.password) },
      { label: "Um n√∫mero", met: /[0-9]/.test(createData.password) },
      { label: "Um caractere especial", met: /[!@#$%^&*(),.?":{}|<>]/.test(createData.password) },
      {
        label: "As senhas coincidem",
        met:
          !!createData.password &&
          !!createData.confirmPassword &&
          createData.password === createData.confirmPassword,
      },
    ],
    [createData.password, createData.confirmPassword]
  );

  const passwordsMatch = useMemo(
    () => passwordRequirements.find((r) => r.label === "As senhas coincidem")?.met ?? false,
    [passwordRequirements]
  );

  const allRequirementsMet = useMemo(
    () => passwordRequirements.every((r) => r.met),
    [passwordRequirements]
  );

  const canContinueName = useMemo(() => createData.name.trim().length >= 3, [createData.name]);
  const canContinueCreateEmail = useMemo(
    () => createEmailValid && createEmailAvailable,
    [createEmailValid, createEmailAvailable]
  );

  const canSubmitCreate = useMemo(() => {
    if (!canContinueName) return false;
    if (!canContinueCreateEmail) return false;
    if (!allRequirementsMet) return false;
    if (!passwordsMatch) return false;
    if (!createData.termsAccepted) return false;
    return true;
  }, [
    canContinueName,
    canContinueCreateEmail,
    allRequirementsMet,
    passwordsMatch,
    createData.termsAccepted,
  ]);

  const handleCreateChange = (field: string, value: string | boolean) => {
    setCreateData((prev) => ({ ...prev, [field]: value }));
    if (createError) setCreateError(null);

    if (field === "email") {
      createEmailCheck.reset();
    }
  };

  const resetCreate = () => {
    setCreateStep("name");
    setCreateError(null);
    createEmailCheck.reset();
    setCreateData({
      name: "",
      email: "",
      password: "",
      confirmPassword: "",
      termsAccepted: false,
    });
    setShowCreatePassword(false);
    setShowCreateConfirmPassword(false);
  };

  const handleCreateSubmit = async (e?: React.FormEvent) => {
    if (e) e.preventDefault();
    if (isLoading) return;

    setCreateError(null);

    if (!canContinueName) {
      setCreateStep("name");
      setCreateError("Digite seu nome completo.");
      return;
    }

    if (!createEmailValid) {
      setCreateStep("email");
      setCreateError("Digite um e-mail v√°lido.");
      return;
    }

    if (!createEmailAvailable) {
      setCreateStep("email");
      setCreateError(createEmailExists ? "E-mail j√° cadastrado." : "E-mail indispon√≠vel.");
      return;
    }

    if (!allRequirementsMet || !passwordsMatch) {
      setCreateStep("password");
      setCreateError("A senha n√£o atende aos requisitos.");
      return;
    }

    if (!createData.termsAccepted) {
      setCreateStep("password");
      setCreateError("Voc√™ precisa aceitar os termos de uso.");
      return;
    }

    setIsLoading(true);

    try {
      const response = await authService.register({
        name: createData.name,
        email: createData.email,
        password: createData.password,
      });

      setAuth(response.user, response.tenant, response.accessToken, response.refreshToken);
      navigate("/dashboard");
    } catch (err: any) {
      const message =
        err?.response?.data?.message ||
        "N√£o foi poss√≠vel criar a conta. Verifique os dados e tente novamente.";
      setCreateError(message);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen w-full bg-white overflow-hidden">
      {/*<style>{`
        @keyframes ml-marquee-left { 0% { transform: translateX(0%); } 100% { transform: translateX(-50%); } }
        @keyframes ml-marquee-right { 0% { transform: translateX(-50%); } 100% { transform: translateX(0%); } }
        @keyframes ml-softPulse { 0%, 100% { transform: scale(1); opacity: 0.95; } 50% { transform: scale(1.02); opacity: 1; } }
        .ml-marquee-track { width: 200%; display: flex; gap: 18px; will-change: transform; }
        .ml-marquee-left { animation: ml-marquee-left 14s linear infinite; }
        .ml-marquee-right { animation: ml-marquee-right 60s linear infinite; }
        .ml-softPulse { animation: ml-softPulse 2.6s ease-in-out infinite; }
      `}</style>*/}

      <AnimatePresence mode="wait">
        {/*{scene === "intro" && (
          <motion.div key="intro" {...pageSwap} className="min-h-screen w-full">
            <IntroScene logo={logo} introReady={introReady} onReady={() => setScene("choice")} />
          </motion.div>
        )}*/}

        {scene === "choice" && (
          <motion.div key="choice" {...pageSwap} className="min-h-screen w-full">
            <ChoiceScene
              logo={logo}
              onStart={() => setScene("createAccount")}
              onHaveAccount={goLogin}
            />
          </motion.div>
        )}

        {scene === "login" && (
          <motion.div key="login" {...pageSwap} className="min-h-screen w-full">
            <div className="min-h-screen w-full flex items-center justify-center p-6 bg-white relative overflow-hidden">
              <div className="absolute inset-0 bg-gradient-to-br from-white via-[var(--color-secondary-blue-10)] to-white" />

              <div className="relative z-10 w-full max-w-[520px] rounded-[28px] bg-white shadow-2xl border border-neutral-200/70">
                <div className="px-8 sm:px-12 pb-10">
                  <div className="flex justify-center">
                    <img src={logo} alt="Logo" className="w-24 h-24 object-contain" />
                  </div>

                  <h1 className="mt-0 text-center text-3xl sm:text-[34px] font-extrabold text-neutral-900">
                    Money Legal
                  </h1>

                  <p className="mt-2 text-center text-[15px] font-medium text-neutral-500">
                    Digite o e-mail cadastrado para localizar sua conta.
                  </p>

                  <div className="mt-6 flex items-center justify-center gap-2">
                    <StepDot active={loginStep === "email"} done={canContinueEmail} />
                    <div className="w-10 h-[2px] bg-neutral-200" />
                    <StepDot active={loginStep === "password"} done={canSubmit} />
                  </div>

                  <form onSubmit={handleSubmit} className="mt-6">
                    <AnimatePresence mode="wait">
                      {loginStep === "email" && (
                        <motion.div key="emailStep" {...fadeSlide} className="space-y-4">
                          <Input
                            type="email"
                            placeholder="Seu e-mail"
                            value={formData.email}
                            onChange={(e) => handleChange("email", e.target.value)}
                            required
                            disabled={isLoading}
                            customRounded="rounded-xl"
                            customBorder="border-2 border-gray-200"
                            customBg="bg-white"
                            leftIcon={<Mail className="w-5 h-5" />}
                            variant={emailInputVariant as any}
                            success={emailExists ? emailHint : undefined}
                            error={emailNotFound ? "Email n√£o encontrado." : undefined}
                            rightIcon={emailRightIcon}
                          />

                          {emailNotFound && (
                            <div className="rounded-2xl border border-neutral-200/70 bg-neutral-50 p-4 ">
                              <div className="text-sm font-semibold text-neutral-900">
                                N√£o achamos essa conta.
                              </div>
                              <div className="text-sm font-medium text-neutral-600 mt-1">
                                Se for seu primeiro acesso, crie sua conta em poucos passos.
                              </div>
                              <div className="mt-3 flex justify-center">
                                <Button
                                  type="button"
                                  variant="outline"
                                  tone="filledLight"
                                  className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
                                  onClick={() => setScene("createAccount")}
                                >
                                  Criar Conta
                                </Button>
                              </div>
                            </div>
                          )}

                          <div className="pt-2 space-y-3 md:flex md:flex-col md:items-center">
                            <Button
                              type="button"
                              variant="outline"
                              tone="filledLight"
                              className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
                              disabled={!canContinueEmail || isLoading || emailChecking}
                              onClick={() => setLoginStep("password")}
                              rightIcon={<ArrowRight className="w-4 h-4" />}
                            >
                              Continuar
                            </Button>

                            <Button
                              type="button"
                              variant="outline"
                              tone="plain"
                              className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
                              onClick={() => setScene("choice")}
                              disabled={isLoading}
                              leftIcon={<ArrowLeft className="w-4 h-4" />}
                            >
                              Voltar
                            </Button>
                          </div>
                        </motion.div>
                      )}

                      {loginStep === "password" && (
                        <motion.div key="passStep" {...fadeSlide} className="space-y-4">
                          <Input
                            type={showPassword ? "text" : "password"}
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            value={formData.password}
                            onChange={(e) => handleChange("password", e.target.value)}
                            required
                            disabled={isLoading}
                            customRounded="rounded-xl"
                            customBorder="border-2 border-gray-200"
                            customBg="bg-white"
                            leftIcon={<Lock className="w-5 h-5" />}
                            error={loginError || undefined}
                            rightIcon={
                              <div className="flex items-center gap-2">
                                {loginError && <XCircle className="w-5 h-5 text-danger-500" />}
                                <button
                                  type="button"
                                  onClick={() => setShowPassword(!showPassword)}
                                  className="text-neutral-400 hover:text-neutral-600 transition-colors"
                                  tabIndex={-1}
                                >
                                  {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                                </button>
                              </div>
                            }
                          />

                          <div className="pt-2 space-y-3 md:flex md:flex-col md:items-center">
                            <Button
                              type="submit"
                              variant="outline"
                              tone="filledLight"
                              className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
                              loading={isLoading}
                              disabled={!canSubmit || isLoading}
                              rightIcon={<LogIn className="w-4 h-4" />}
                            >
                              {isLoading ? "Entrando..." : "Entrar"}
                            </Button>

                            <Button
                              type="button"
                              variant="outline"
                              tone="plain"
                              className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
                              onClick={() => {
                                setFormData((p) => ({ ...p, email: "", password: "" }));
                                emailCheck.reset();
                                setLoginError(null);
                                setLoginStep("email");
                              }}
                              disabled={isLoading}
                              leftIcon={<ArrowLeft className="w-4 h-4" />}
                            >
                              Voltar
                            </Button>

                            <div className="mt-3 text-center">
                              <Link to="/register" className="text-sm font-medium text-color-secondary-blue-100">
                                Esqueceu a senha?
                              </Link>
                            </div>
                          </div>
                        </motion.div>
                      )}
                    </AnimatePresence>
                  </form>
                </div>
              </div>
            </div>
          </motion.div>
        )}

        {/* ------------------------ NEW SCENE: CREATE ACCOUNT ------------------------ */}
        {scene === "createAccount" && (
          <motion.div key="createAccount" {...pageSwap} className="min-h-screen w-full">
            <div className="min-h-screen w-full flex items-center justify-center p-6 bg-white relative overflow-hidden">
              <div className="absolute inset-0 bg-gradient-to-br from-white via-[var(--color-secondary-blue-10)] to-white" />

              <div className="relative z-10 w-full max-w-[520px] rounded-[28px] bg-white shadow-2xl border border-neutral-200/70">
                <div className="px-8 sm:px-12 pb-10">
                  <div className="flex justify-center">
                    <img src={logo} alt="Logo" className="w-24 h-24 object-contain" />
                  </div>

                  <h1 className="mt-0 text-center text-3xl sm:text-[34px] font-extrabold text-neutral-900">
                    Money Legal
                  </h1>

                  <p className="mt-2 text-center text-[15px] font-medium text-neutral-500">
                    Forne√ßa os dados pedidos e crie sua conta.
                  </p>

                  <div className="mt-6 flex items-center justify-center gap-2">
                    <StepDot active={createStep === "name"} done={canContinueName} />
                    <div className="w-10 h-[2px] bg-neutral-200" />
                    <StepDot active={createStep === "email"} done={canContinueCreateEmail} />
                    <div className="w-10 h-[2px] bg-neutral-200" />
                    <StepDot active={createStep === "password"} done={canSubmitCreate} />
                  </div>

                  {createError && (
                    <div className="mt-6 rounded-xl border border-danger-200 bg-danger-50 p-3">
                      <div className="flex items-center gap-2 text-sm text-danger-700">
                        <XCircle className="w-5 h-5 text-danger-500" />
                        <span>{createError}</span>
                      </div>
                    </div>
                  )}

                  <form onSubmit={handleCreateSubmit} className="mt-6">
                    <AnimatePresence mode="wait">
                      {createStep === "name" && (
                        <motion.div key="create-name" {...fadeSlide} className="space-y-4">
                          <Input
                            type="text"
                            placeholder="Nome completo"
                            value={createData.name}
                            onChange={(e) => handleCreateChange("name", e.target.value)}
                            required
                            disabled={isLoading}
                            customRounded="rounded-xl"
                            customBorder="border-2 border-gray-200"
                            customBg="bg-white"
                            leftIcon={<User className="w-5 h-5" />}
                          />

                          <div className="pt-2 space-y-3 md:flex md:flex-col md:items-center">
                            <Button
                              type="button"
                              variant="outline"
                              tone="filledLight"
                              className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
                              disabled={!canContinueName || isLoading}
                              onClick={() => setCreateStep("email")}
                              rightIcon={<ArrowRight className="w-4 h-4" />}
                            >
                              Continuar
                            </Button>

                            <Button
                              type="button"
                              variant="outline"
                              tone="plain"
                              className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
                              onClick={() => {
                                resetCreate();
                                setScene("choice");
                              }}
                              disabled={isLoading}
                              leftIcon={<ArrowLeft className="w-4 h-4" />}
                            >
                              Voltar
                            </Button>
                          </div>
                        </motion.div>
                      )}

                      {createStep === "email" && (
                        <motion.div key="create-email" {...fadeSlide} className="space-y-4">
                          <Input
                            type="email"
                            placeholder="Seu e-mail"
                            value={createData.email}
                            onChange={(e) => handleCreateChange("email", e.target.value)}
                            required
                            disabled={isLoading}
                            customRounded="rounded-xl"
                            customBorder="border-2 border-gray-200"
                            customBg="bg-white"
                            leftIcon={<Mail className="w-5 h-5" />}
                            variant={createEmailInputVariant as any}
                            success={createEmailAvailable ? createEmailHint : undefined}
                            error={createEmailExists ? "E-mail j√° cadastrado." : undefined}
                            rightIcon={createEmailRightIcon}
                          />

                          {createEmailExists && (
                            <div className="rounded-2xl border border-neutral-200/70 bg-neutral-50 p-4">
                              <div className="text-sm font-semibold text-neutral-900">
                                Esse e-mail j√° tem conta.
                              </div>
                              <div className="text-sm font-medium text-neutral-600 mt-1">
                                Entre com seu e-mail e senha para continuar.
                              </div>
                              <div className="mt-3 flex justify-center">
                                <Button
                                  type="button"
                                  variant="outline"
                                  tone="filledLight"
                                  className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
                                  onClick={() => {
                                    resetCreate();
                                    setScene("login");
                                    setLoginStep("email");
                                  }}
                                >
                                  Ir para Login
                                </Button>
                              </div>
                            </div>
                          )}

                          <div className="pt-2 space-y-3 md:flex md:flex-col md:items-center">
                            <Button
                              type="button"
                              variant="outline"
                              tone="filledLight"
                              className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
                              disabled={!canContinueCreateEmail || isLoading || createEmailChecking}
                              onClick={() => setCreateStep("password")}
                              rightIcon={<ArrowRight className="w-4 h-4" />}
                            >
                              Continuar
                            </Button>

                            <Button
                              type="button"
                              variant="outline"
                              tone="plain"
                              className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
                              onClick={() => setCreateStep("name")}
                              disabled={isLoading}
                              leftIcon={<ArrowLeft className="w-4 h-4" />}
                            >
                              Voltar
                            </Button>
                          </div>
                        </motion.div>
                      )}

                      {createStep === "password" && (
                        <motion.div key="create-password" {...fadeSlide} className="space-y-4">
                          <Input
                            type={showCreatePassword ? "text" : "password"}
                            placeholder="Senha ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            value={createData.password}
                            onChange={(e) => handleCreateChange("password", e.target.value)}
                            required
                            disabled={isLoading}
                            customRounded="rounded-xl"
                            customBorder="border-2 border-gray-200"
                            customBg="bg-white"
                            leftIcon={<Lock className="w-5 h-5" />}
                            rightIcon={
                              <button
                                type="button"
                                onClick={() => setShowCreatePassword(!showCreatePassword)}
                                className="text-neutral-400 hover:text-neutral-600 transition-colors"
                                tabIndex={-1}
                              >
                                {showCreatePassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                              </button>
                            }
                          />

                          <Input
                            type={showCreateConfirmPassword ? "text" : "password"}
                            placeholder="Confirmar senha ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            value={createData.confirmPassword}
                            onChange={(e) => handleCreateChange("confirmPassword", e.target.value)}
                            required
                            disabled={isLoading}
                            customRounded="rounded-xl"
                            customBorder="border-2 border-gray-200"
                            customBg="bg-white"
                            leftIcon={<Lock className="w-5 h-5" />}
                            rightIcon={
                              <button
                                type="button"
                                onClick={() => setShowCreateConfirmPassword(!showCreateConfirmPassword)}
                                className="text-neutral-400 hover:text-neutral-600 transition-colors"
                                tabIndex={-1}
                              >
                                {showCreateConfirmPassword ? (
                                  <EyeOff className="w-5 h-5" />
                                ) : (
                                  <Eye className="w-5 h-5" />
                                )}
                              </button>
                            }
                          />

                          <div className="mt-2 space-y-2 p-3 bg-neutral-50 rounded-xl border border-neutral-200/70">
                            <p className="text-xs font-semibold text-neutral-600 mb-2">Requisitos da senha:</p>
                            {passwordRequirements.map((req, index) => (
                              <div key={index} className="flex items-center gap-2 text-xs">
                                {req.met ? (
                                  <CheckCircle className="w-4 h-4 text-success-600" />
                                ) : (
                                  <XCircle className="w-4 h-4 text-neutral-400" />
                                )}
                                <span className={req.met ? "text-success-600 font-medium" : "text-neutral-500"}>
                                  {req.label}
                                </span>
                              </div>
                            ))}
                          </div>

                          <label className="flex gap-3 cursor-pointer pt-2">
                            <input
                              type="checkbox"
                              checked={createData.termsAccepted}
                              onChange={(e) => handleCreateChange("termsAccepted", e.target.checked)}
                              disabled={isLoading}
                              required
                              className="mt-1 w-4 h-4 rounded border-neutral-300 text-brand-primary-600 focus:ring-brand-primary-500"
                            />
                            <span className="text-sm text-neutral-600 leading-tight">
                              Estou de acordo com os{" "}
                              <Link
                                to="/terms"
                                className="font-medium text-[var(--color-primary-blue-100)] hover:text-[var(--color-secondary-blue-100)]"
                              >
                                Termos de Uso
                              </Link>{" "}
                              e a{" "}
                              <Link
                                to="/privacy"
                                className="font-medium text-[var(--color-primary-blue-100)] hover:text-[var(--color-secondary-blue-100)]"
                              >
                                Pol√≠tica de Privacidade
                              </Link>
                            </span>
                          </label>

                          <div className="pt-2 space-y-3 md:flex md:flex-col md:items-center">
                            <Button
                              type="submit"
                              variant="outline"
                              tone="filledLight"
                              className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
                              loading={isLoading}
                              disabled={!canSubmitCreate || isLoading}
                              rightIcon={<LogIn className="w-4 h-4" />}
                            >
                              {isLoading ? "Criando..." : "Criar Conta"}
                            </Button>

                            <Button
                              type="button"
                              variant="outline"
                              tone="plain"
                              className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
                              onClick={() => setCreateStep("email")}
                              disabled={isLoading}
                              leftIcon={<ArrowLeft className="w-4 h-4" />}
                            >
                              Voltar
                            </Button>
                          </div>
                        </motion.div>
                      )}
                    </AnimatePresence>
                  </form>
                </div>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
};

/* ----------------------------- CENA 1: INTRO ----------------------------- */
/*
function IntroScene({
  logo,
  introReady,
  onReady,
}: {
  logo: string;
  introReady: boolean;
  onReady: () => void;
}) {
  const benefits = [
    { icon: "üöÄ", title: "Onboarding r√°pido", description: "Comece a utilizar em poucos passos." },
    { icon: "‚ú®", title: "Gest√£o Inteligente", description: "Aprovar suas contas √© t√£o f√°cil como curtir um post." },
    { icon: "üóÇÔ∏è", title: "Multi usu√°rios de verdade", description: "Grupos isolados, sem impacto entre opera√ß√µes." },
    { icon: "‚ö°", title: "Velocidade", description: "Tudo responde r√°pido e eficiente." },
    { icon: "üîí", title: "Seguran√ßa", description: "Sess√£o protegida e dados criptografados." },
  ];

  const loop = [...benefits, ...benefits];

  return (
    <div className="min-h-screen w-full relative overflow-hidden">
      <div className="absolute inset-0 bg-gradient-to-br from-[var(--color-primary-blue-10)] via-white to-[var(--color-secondary-blue-10)]" />
      <div className="absolute inset-0 opacity-[0.6]">
        <div className="absolute -top-24 -left-24 w-[420px] h-[420px] rounded-full bg-[var(--color-primary-blue-20)] blur-3xl" />
        <div className="absolute -bottom-24 -right-24 w-[520px] h-[520px] rounded-full bg-[var(--color-secondary-blue-20)] blur-3xl" />
      </div>

      <div className="relative z-10 min-h-screen flex items-center justify-center px-6 py-10">
        <div className="w-full max-w-[980px]">
          <motion.div {...fadeSlide} className="flex flex-col items-center text-center">
            <img src={logo} alt="Logo" className="w-24 h-24 object-contain ml-softPulse" />
            <h1 className="mt-0 text-3xl sm:text-5xl font-extrabold text-neutral-900 tracking-tight">
              Money Legal
            </h1>
            <p className="text-xl text-neutral-600 mb-10 max-w-[60ch]">
              Junte-se a milhares de usu√°rios que j√° transformaram a forma como gerenciam seu dinheiro.
            </p>
          </motion.div>

          <div className="w-full mb-16 px-6 sm:px-8 lg:px-12">
            <div className="relative">
              <div className="overflow-hidden pb-6">
                <div className="ml-marquee-track ml-marquee-left">
                  {loop.map((b, i) => (
                    <div
                      key={`L-${b.title}-${i}`}
                      className="min-w-[260px] sm:min-w-[300px] rounded-2xl bg-white/75 px-4 py-3 shadow-md"
                    >
                      <div className="flex-shrink-0 w-12 h-12 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center text-3xl">
                        {b.icon}
                      </div>
                      <div>
                        <div className="font-semibold text-lg mb-1">{b.title}</div>
                        <div className="text-neutral-900">{b.description}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>

          <div className="mt-10 flex justify-center">
            <AnimatePresence>
              {introReady && (
                <motion.div
                  initial={{ opacity: 0, y: 14, filter: "blur(8px)" }}
                  animate={{ opacity: 1, y: 0, filter: "blur(0px)", transition: { duration: 0.45, ease } }}
                  exit={{ opacity: 0, y: 8, transition: { duration: 0.25, ease } }}
                >
                  <Button
                    variant="outline"
                    tone="filledLight"
                    className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
                    onClick={onReady}
                  >
                    Estou Pronto! <ArrowRight className="w-4 h-4" />
                  </Button>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        </div>
      </div>
    </div>
  );
}
*/
/* ---------------------------- CENA 2: CHOICE ---------------------------- */

function ChoiceScene({
  logo,
  onStart,
  onHaveAccount,
}: {
  logo: string;
  onStart: () => void;
  onHaveAccount: () => void;
}) {
  return (
    <div className="min-h-screen w-full flex items-center justify-center px-6 py-10 relative overflow-hidden bg-white">
      <div className="absolute inset-0 bg-gradient-to-br from-white via-[var(--color-primary-blue-10)] to-white" />

      <div className="relative z-10 w-full max-w-[560px]">
        <motion.div
          {...fadeSlide}
          className="rounded-[28px] bg-white shadow-2xl border border-neutral-200/70 px-8 sm:px-10 py-10"
        >
          <div className="flex justify-center">
            <img src={logo} alt="Logo" className="w-24 h-24 object-contain" />
          </div>

          <h1 className="mt-0 text-center text-3xl sm:text-[34px] font-extrabold text-neutral-900">
            Money Legal
          </h1>

          <p className="mt-2 text-center text-[15px] font-medium text-neutral-600">
            Se for novo por aqui, clique em Comece Agora e crie sua conta de acesso.
          </p>

          <div className="mt-8 space-y-3 md:flex md:flex-col md:items-center">
            <Button
              variant="outline"
              tone="filledLight"
              className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
              onClick={onStart}
              rightIcon={<Rocket className="w-4 h-4" />}
            >
              Comece Agora
            </Button>

            <Button
              variant="outline"
              tone="plain"
              className="w-full md:!w-auto md:!px-8 md:min-w-[220px]"
              onClick={onHaveAccount}
              rightIcon={<LogIn className="w-4 h-4" />}
            >
              J√° tenho conta
            </Button>
          </div>
        </motion.div>
      </div>
    </div>
  );
}

function StepDot({ active, done }: { active: boolean; done: boolean }) {
  const className = [
    "w-3 h-3 rounded-full transition-all",
    done ? "bg-success-500" : active ? "bg-neutral-900" : "bg-neutral-300",
  ].join(" ");

  return <div className={className} />;
}

export default LoginPage;
